{% extends 'base.html.twig' %}

{% block title %}
	{{ vehicle.brand }}
	-
	{{ vehicle.model }}
{% endblock %}

{% block body %}
	<div class="max-w-4xl mx-auto p-4">
		{% for label, messages in app.flashes %}
			{% for message in messages %}
				<div class="mb-4 p-4 rounded-lg {% if label == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
					{{ message }}
				</div>
			{% endfor %}
		{% endfor %}

		<div class="text-center mb-8">
			<h1 class="text-4xl font-extrabold text-gray-800">{{ vehicle.brand }}
				-
				{{ vehicle.model }}</h1>
		</div>

		<div class="flex flex-col lg:flex-row bg-gradient-to-r from-gray-100 via-gray-200 to-gray-300 shadow-xl rounded-lg overflow-hidden">
			<div class="lg:w-1/2 p-4">
				<div class="mb-4">
					<img src="{{ vehicle.defaultImage }}" alt="{{ vehicle.model }}" class="w-full h-80 object-cover rounded-lg shadow-lg border-4 border-gray-300 transition-transform transform hover:scale-105" id="mainImage">
				</div>

				{% if vehicle.vehicleImages|length > 0 %}
					<div class="grid grid-cols-4 gap-2 mt-4">
						<div class="aspect-w-16 aspect-h-9">
							<img src="{{ vehicle.defaultImage }}" alt="Image par défaut" class="w-full h-20 object-cover rounded cursor-pointer hover:opacity-75 transition-opacity" onclick="changeMainImage(this.src)">
						</div>
						{% for image in vehicle.vehicleImages %}
							<div class="aspect-w-16 aspect-h-9">
								<img src="{{ asset('uploads/vehicles/' ~ image.url) }}" alt="Image {{ loop.index }}" class="w-full h-20 object-cover rounded cursor-pointer hover:opacity-75 transition-opacity" onclick="changeMainImage(this.src)">
							</div>
						{% endfor %}
					</div>
				{% endif %}
			</div>

			<div class="lg:w-1/2 p-6 bg-gray-100">
				<div class="text-center mb-6">
					<h2 class="text-3xl font-semibold text-gray-700">Détails du véhicule</h2>
				</div>

				<ul class="space-y-4 text-gray-600 text-lg">
					{% if type == 'Car' %}
						<li>
							<strong class="text-blue-600">Nombre de sièges:</strong>
							{{ vehicle.nbSeats }}
						</li>
						<li>
							<strong class="text-blue-600">Nombre de portes:</strong>
							{{ vehicle.nbDoors }}
						</li>
						<li>
							<strong class="text-blue-600">Taille du coffre:</strong>
							{{ vehicle.trunkSize }}
							L
						</li>
						<li>
							<strong class="text-blue-600">Transmission:</strong>
							{{ vehicle.transmission }}
						</li>
					{% elseif type == 'Van' %}
						<li>
							<strong class="text-blue-600">Volume de chargement:</strong>
							{{ vehicle.cargoVolume }}
							m³
						</li>
					{% elseif type == 'Motorcycle' %}
						<li>
							<strong class="text-blue-600">Cylindrée:</strong>
							{{ vehicle.engineCapacity }}
							cc
						</li>
					{% endif %}

					<li>
						<strong class="text-blue-600">Année:</strong>
						{{ vehicle.year }}
					</li>
					<li>
						<strong class="text-blue-600">Kilométrage:</strong>
						{{ vehicle.mileage }}
						km
					</li>
					<li>
						<strong class="text-yellow-800">Type carburant:</strong>
						{{ vehicle.fuelType }}
					</li>
					<li>
						<strong class="text-blue-600">Catégories:</strong>
						{% for category in categories %}
							<span class="bg-blue-200 text-blue-700 py-1 px-3 rounded-full text-sm">{{ category.name }}</span>
						{% else %}
							Aucune catégorie disponible.
						{% endfor %}
					</li>
					<li>
						<form action="{{ path('app_add_reservation', { vehicleId: vehicle.id }) }}" >
							<button type="submit" class="w-full md:w-auto bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 ml-4">
								Réserver
							</button>
						</form>
					</li>
					<li>
						<button type="button" class="w-full md:w-auto bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 ml-4">
							Contactez-nous
						</button>
					</li>
				</ul>
			</div>
		</div>
	</div>
</div>


<div class=" container mt-12">
	<h3 class="text-3xl font-semibold text-indigo-800 mb-6">Avis clients</h3>

	<div class="mb-8">
		<div class="flex items-center">
			<div class="flex items-center">
				{% for i in 1..5 %}
					{% if i <= averageRating %}
						<i class="fas fa-star text-yellow-400"></i>
					{% else %}
						<i class="far fa-star text-yellow-400"></i>
					{% endif %}
				{% endfor %}
			</div>
			<span class="ml-2 text-lg text-gray-600">{{ averageRating }}/5 ({{ reviews|length }}
				avis)</span>
		</div>
	</div>

	{% if app.user %}
		<div class="bg-white p-6 rounded-lg shadow-md mb-8">
			<h4 class="text-xl font-semibold mb-4">Donnez votre avis</h4>
			<form action="{{ path('app_review_add', {'vehicleId': vehicle.id}) }}" method="POST" class="space-y-4" id="reviewForm">
				<div class="rating flex space-x-1 mb-4">
					{% for i in 1..5 %}
						<input type="radio" name="rating" value="{{ i }}" id="star{{ i }}" class="hidden">
						<label for="star{{ i }}" class="cursor-pointer">
							<i class="far fa-star text-1xl text-yellow-400"></i>
						</label>
					{% endfor %}
				</div>
				<div>
					<label class="block text-gray-700 mb-2">Commentaire</label>
					<textarea name="comment" rows="4" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" required></textarea>
				</div>
				<button type="submit" class="bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-300">
					Publier mon avis
				</button>
			</form>
		</div>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
const ratingContainer = document.querySelector('.rating');
const stars = ratingContainer.querySelectorAll('i');
const inputs = ratingContainer.querySelectorAll('input');

function fillStars(selectedIndex) {
stars.forEach((star, index) => {
if (index <= selectedIndex) {
star.classList.remove('far');
star.classList.add('fas');
} else {
star.classList.remove('fas');
star.classList.add('far');
}
});
}


stars.forEach((star, index) => {
const label = star.parentElement;

label.addEventListener('mouseover', () => {
fillStars(index);
});


label.addEventListener('mouseout', () => {
const selectedInput = Array.from(inputs).find(input => input.checked);
const selectedIndex = selectedInput ? parseInt(selectedInput.value) - 1 : -1;
fillStars(selectedIndex);
});


label.addEventListener('click', () => {
inputs[index].checked = true;
fillStars(index);
});
});
});

document.getElementById('reviewForm').addEventListener('submit', function (e) {
e.preventDefault();
const formData = new FormData(this);
console.log('Données du formulaire:', {
rating: formData.get('rating'),
comment: formData.get('comment')
});
this.submit();
});
		</script>
	{% endif %}

	<div class="space-y-6">
		{% for review in reviews %}
			{% if not review.parent %}
				<div class="bg-white p-6 rounded-lg shadow-md">
					<div class="flex justify-between items-start mb-4">
						<div>
							<div class="flex items-center mb-2">
								{% for i in 1..5 %}
									{% if i <= review.rating %}
										<i class="fas fa-star text-yellow-400"></i>
									{% else %}
										<i class="far fa-star text-yellow-400"></i>
									{% endif %}
								{% endfor %}
							</div>
							<p class="text-gray-600">Par
								{{ review.publisher.firstName }}
								{{ review.publisher.lastName }}
								le
								{{ review.createdAt|date('d/m/Y') }}</p>
						</div>
						{% if app.user and app.user == review.publisher %}
							<div class="flex space-x-2">
								<a href="{{ path('app_review_edit', {'id': review.id}) }}" class="text-blue-600 hover:text-blue-800">
									<i class="fas fa-edit"></i>
								</a>
								<a href="{{ path('app_review_delete', {'id': review.id}) }}" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet avis ?')" class="text-red-600 hover:text-red-800">
									<i class="fas fa-trash"></i>
								</a>
							</div>
						{% endif %}
					</div>
					<p class="text-gray-700">{{ review.comment }}</p>

										<div class="mt-4 ml-8 space-y-4">
						{% for reply in review.replies %}
							<div class="bg-gray-50 p-4 rounded-lg border-l-4 border-gray-300">
								<div class="flex justify-between items-start mb-2">
									<p class="text-gray-600">Réponse de
										{{ reply.publisher.firstName }}
										{{ reply.publisher.lastName }}
										le
										{{ reply.createdAt|date('d/m/Y') }}</p>
									{% if app.user and app.user == reply.publisher %}
										<div class="flex space-x-2">
											<a href="{{ path('app_review_edit_reply', {'id': reply.id}) }}" class="text-blue-600 hover:text-blue-800">
												<i class="fas fa-edit"></i>
											</a>
											<a href="{{ path('app_review_delete', {'id': reply.id}) }}" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette réponse ?')" class="text-red-600 hover:text-red-800">
												<i class="fas fa-trash"></i>
											</a>
										</div>
									{% endif %}
								</div>
								<p class="text-gray-700">{{ reply.comment }}</p>
							</div>
						{% endfor %}
					</div>

					{% if app.user %}
						<button onclick="toggleReplyForm('reply-form-{{ review.id }}')" class="mt-4 text-black hover:text-gray-800 text-sm font-medium">
							Répondre
						</button>
						<form id="reply-form-{{ review.id }}" action="{{ path('app_review_reply', {'id': review.id}) }}" method="POST" class="mt-4 ml-8 hidden">
							<textarea name="comment" rows="3" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" required placeholder="Votre réponse..."></textarea>
							<button type="submit" class="mt-2 bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-300">
								Publier la réponse
							</button>
						</form>
					{% endif %}
				</div>
			{% endif %}
		{% else %}
			<p class="text-gray-600 text-center">Aucun avis pour le moment.</p>
		{% endfor %}
	</div>
</div>

{% block javascripts %}
	<script>
		function toggleReplyForm(formId) {
const form = document.getElementById(formId);
form.classList.toggle('hidden');
}

function changeMainImage(src) {
document.getElementById('mainImage').src = src;
}
	</script>


{% endblock %}{% endblock %}
